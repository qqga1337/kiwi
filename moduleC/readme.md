
# Модуль 3

## Введение

Компания "Облачные решения для бизнеса" занимается проектированием, развертыванием и миграцией IT-систем. 
Вы являетесь DevOps-инженером, который занимается настройкой вычислительной инфраструктуры с приминением систем оркестрации.

Поздравляю с успешным развертыванием инфраструктуры! Компания "Вечность пахнет нефтью" очень довольна тем, что их приложение теперь имеет
высокую доступность, отказоустойчивость и масштабируемость!
Пару дней назад компания снова обратилась за помощью - их отдел разработки желаеет настроить процесс непрерывной интеграции и доставки приложения в кластер, реализация чего была поручена вам. 

Так же, отдел эксплуатации так же желает иметь возможность загружать определенные версии контейнеров, используя методологию ChatOPS.



## Процесс непрерывной интеграции
Вам будет предоставлен токен для бота и URL к нему, а так же чат, в который надо будет отправлять лог работы пайплайна в виде "Пайплайн {номер_пайплайна} {время_запуска пайплайна} {имя_ветки} {создан/завершен успешно/завершен неуспешно}"

Исходный код приложения будет находиться в репозитории по ссылке выше

Вашей задачей будет настроить CI пайплайн, который будет заниматься следующими задачами:
* Проверять код на валидность через линтер PyLint, он должен обращать внимание только на критичные ошибки
* Собираться в облегченный OCI контейнер c использованием alpine
* Проходить первоначальную проверку, что он корректно запускается и отдает базовый ответ, а то есть успешно отвечает 200 кодом по пути /health
* Собранный контейнер отправляется в Gitlab Registry
* Отдельным выбором в пайплайне мы можем произвести заливку данного контейнера в Kubernetes, при помощи сервиса Argo CD на замену тому, что находится в Deployment - **oil-refinery-application**
* Уведомлять в Telegram бота о начале работы пайплайна, успешном или неуспешном выполнении 
* Тег создаваемого и добавляемого в реестр контейнера должен соответствовать названию ветки

## ChatOPS
Вам необходимо сделать чат-бота в Telegram и разместить его удобным вам способом на одной из ВМ или в кластере Kubernetes. 
Для реализации данной задачи вам будет выдан API ключ от бота и ссылка на него, так же вам будет передан идентификатор и ссылка группы, в которую нужно будет отсылать состояние вашего пайплайна.
Задача выше предполагает, что в рамках пайплайна вы будете отправлять API запросы напрямую в Telegram, а реализация бота для ответа на команды человеку реализована через Long Polling.

Реализуйте следующие команды в боте:

> * **/showcontainers** - показывает все версии контейнера в репозитории
> 
> * **/deploy** _{version}_ - установить указаную версию контейнера у Deployment по имени oil-refinery-application
> 
> * **/set_replicas** - настроить количество реплик у Deployment по имени oil-refinery-application
> 
> * **/get_nodes** - вывести список всех нод кластера, их внешний адрес и отображает возможность размещения на них подов
> 
> * **/cordon** _{node_name}_ - вывести ноду из списка нод, доступных для размещения подов
> 
> * **/uncordon** _{node_name}_ - вернуть ноду в список нод, доступных для размещения подов
> 
> * **/get_pods** - получить наименование всех Pod у Deployment oil-refinery-application
> 
> * **/get_logs** {pod_name} - вывести последние 30 строк логов выбранного пода пода


## Как это будет проверяться
Выполнение вашей работы будет проходить последовательно, сначала процесс непрерывной интеграции, а после работа ChatOPS.
При проверке непрерывной интеграции, мы зайдем на ваш GitLab в репозиторий, созданный в предыдущий день, так как ожидается реализация пайплайна именно в нем. После чего будет создана новая ветка c произвольным названием в виде условной версии приложения, например "0.10.5". Сама ветка будет являться копией ветки main/master. Далее, команда оценки будет наблюдать за процессом непрерывной интеграции.

Проверка ChatOPS будет происходить отправкой команд в ЛС самого бота.

Проверка оповещений о работе пайплайнов будет проходить в общем чате.
