#######  Настройка L-RTR.DIGITSL.RU  ##########
hostnamectl set-hostname c-rtr.digital.ru
echo "127.0.0.1 c-rtr.digital.ru c-rtr" >> /etc/hosts
#Устанавливаем FreeIPA сервер
apt update
apt install astra-freeipa-server astra-freeipa-client -y
#Настройка файрвола
cat > /etc/network/if-pre-up.d/iptables <<EOF
#!/bin/sh
iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE
exit 0
EOF
#Разрешаем запуск скрипта
chmod +x /etc/network/if-pre-up.d/iptables
# Сразу его запускаем
/etc/network/if-pre-up.d/iptables
# Включаем Ip форвардинг
echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.conf
# Тут же применяем настройки
sysctl -p

# WireGuard C-RTR

# Устанавливаем WireGuard
apt install wireguard -y
# Подключаем модули ядра WireGuard
modprobe wireguard
# Создаем приватный ключ
echo "GDB6RVAu02VPK71WW86v915ubcTkkZHE8Kq2g+nlAG0=" > /etc/wireguard/privatekey 
# Создаем Публичный ключ
echo "WbkKz0hE6dXYSzsSGag5ywYm61IVrqdrH2tff/UpaAk=" > /etc/wireguard/publickey 
# Создаем конфигурационный файл
cat > /etc/wireguard/wg0.conf <<EOF
[Interface]
ListenPort = 51820
Address = 172.16.1.1/24
PrivateKey = GDB6RVAu02VPK71WW86v915ubcTkkZHE8Kq2g+nlAG0= 

[Peer]
PublicKey = ILV9zHII224tr+pk69H6SsM06+EWzDvFUdyxK7MIggo=
AllowedIPs = 10.1.1.0/24,172.16.1.0/24
PersistentKeepAlive = 5
EOF

# Запускаем службу WG и ставим ее в автозапуск
systemctl enable --now wg-quick@wg0
# Смотрим статус подключения
wg show wg0
# Если не прокатило: wg genkey | tee /etc/wireguard/privatekey | wg pubkey | tee /etc/wireguard/publickey
#
# ВВодим в домен
astra-freeipa-client -d digital.ru

# Повышаем до уровня резервного контроллера доена
astra-freeipa-replica --dogtag


