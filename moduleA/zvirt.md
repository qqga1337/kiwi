# Деплоим zvirt

## Проверка инфраструктуры

У нас должно быть:

1. Как минимум три ноды
2. На каждую ноду не меньше 100гб диска
3. На каждую ноду не меньше  4гб озу
4. Включена паравиртуализация. Проверить можно так:
    - `lscpu | grep -i virtualization`
    -  `egrep -i 'svm|vmx' /proc/cpuinfo`
    - `virt-host-validate` -- если утановлен libvirt
5. Шареный сторадж (nfs, iscsi, gluster, ceph(не уверен)). Как деплоить nfs -- читай [тут](/moduleA/nfs.md). 
    - На шаре должно быть свободно МИНИМУМ 60ГБ


!!!Очень важно сначала нормально настроить хранение, а уже потом деплоить zvirt. Отказ хранения он переживает крайне плохо!!!

!!!Перед любыми манипуляциями с внешним хранилищем или чем-то еще желательно выключать hosted-engine. Идем на ноду, на которой деплоили и пишем `hosted-engine --vm-shutdown`. Если так не работает, можно писать `hosted-engine --vm-poweroff`!!!

Развернули NFS сервер -- можно деплоить ноду


## Деплоим ноды

1. Берем исо и грузимся с него.
2. В установщике выбираем первый пункт, который без test media -- позволяет сэкономить время
3. В установщике конфигурим
    - Keyboard -- зашли, нажали ок
    - Time & Date -- поставили нормальный часовой пояс и желательно время
    - Installation Destination -- зашли, нажали ок. 
    **Если висит ошибка kickstart infusient -- мало места на диске, куда собираешься ставится**
    - Network & host name -- зашли, сразу сконфигурили сеть и хостнейм. Ставим везде статику и нормальные хостнеймы
    - Root Password -- сделаем пароль от рута, чтоб везде нормально ходить
4. Нажали Begin Installation и ждем сидим. Пока одна нода ставится -- можно поставить другие.

## Подготовка к установке hosted engine

1. Заполняем файлик /etc/hosts на каждой ноде, либо добавляем записи в DNS
    - адрес, полное, сокращенное имя каждой ноды (1.1.1.1 node1.itnsa.lab node1)
    - Адрес, полное, сокращенное имя hosted engine (2.2.2.2 engine.itnsa.lab engine)
    - Адрес hosted engine должен быть свободен и должен нормально резолвится

Пример правильно заполненного файлика

```
#/etc/hosts

192.168.122.212 node1.itnsa.lab node1
192.168.122.90 node2.itnsa.lab node2
192.168.122.228 node3.itnsa.lab node3
192.168.122.100 engine.itnsa.lab engine
```

2. Ставим RPM hosted-engine и appliance.

Скачиваем, кидаем их в /root и делаем `dnf install -y /root/zvirt-appliance.rpm`

Это делается только на ноде, откуда мы деплоим hosted-engine. На всех нодах это делать не надо.

Если нам предлагают качать все из инета -- делаем так (USERNAME и PASSWORD должны выдать)

```
# dnf config-manager --enable centos-zvirt-main
# zvirt-credentials -u USERNAME -p PASSWORD 
# dnf clean all
# dnf update
# dnf install -y zvirt-hosted-engine ovirt-engine-appliance
```

## Установка hosted-engine

1. Запускаем tmux (зачем, не знаю, но в мане рекомендуют)

2. `hosted-engine --deploy`
    - На первый вопрос отвечаем Yes
    - На второй вопрос пишем адрес шлюза (он его должен сам подсосать)
    - На третий вопрос указываем сетевку, которая будет в менеджмент сети для engine. В идеале у нас одна сетевка. Если не одна -- указываем ту, через которую будем подключатся к zvirt
    - На четвертый вопрос указываем, как будем проверять сеть. Если есть dns сервер -- выбираем dns. Если нет -- выбираем ping
    - Datacenter и Cluster оставляем по умолчанию (если в задании не прописано менять их имена)
    - Попросит указать путь к ова -- ничего не указываем
    - На вопрос про ресурсы ставим как минимум 4 vCPU и как минимум 4096 памяти. Памяти лучше бахнуть 16384
    - engine vm fqdn -- указываем имя, которое мы зарезервировали для engine. В моем примере это engine.itnsa.lab
    - Домен указываем как есть, в моем примере это itnsa.lab
    - Пароль от рута либо из задания, либо P@ssw0rd
    - Открытый ключ скипаем, если нужно -- пишем путь до файла с ключем (id_rsa.pub)
    - ssh под рутом пишем yes
    - OpenSCAP не надо, пишем No
    - FIPS тоже не надо, пишем No
    - Мак адрес оставляем какой он предлагает
    - Адрес выбираем Static
    - Вбиваем адрес, который мы прописывали для engine.itnsa.lab
    - Вбиваем DNS сервер для engine (если есть)
    - Спросит, надо ли редачить /etc/hosts -- конечно надо
    - SMTP конфига вся по дефолту
    - Пароль от админа либо берем из задания, либо P@ssw0rd
    - Хостнейм текущего хоста -- указываем fqdn хоста, на котором работаем
    - Ждем ждем ждем
    - Сторадж -- выбираем nfs как самый простой вариант
    - Версия NFS -- auto
    - Путь -- указываем путь как обычно. В моем примере 192.168.122.69:/mnt/nfs (Папка должна быть обязательно пустой)
    - На activating storage domain может повисеть -- это не страшно. Если какие-то другие траблы -- чекай права и владельца/группу, а также запись в /etc/exports
    - Размер диска -- оставляем по умолчанию
    - Как увидели надпись Hosted Engine successfully deployed так и все

Кстати, все то же самое можно сделать через кокпит. Для этого

- Предварительно делаем все настройки и ставим пакет
- Заходим на ноду через веб браузер, порт 9090
- Идем в приложение zvirt
- Тыкаем кнопки, там все понятно

## Проверяем, что все работает

Берем любой клиент с гуи и идем на адрес апплаенса. В моем примере engine.itnsa.lab

Там тыкаем портал администрирования, вводим креды от админа, которые указывали при установке, наслаждаемся.

# Добавляем хосты

1. Идем в ресурсы -> хосты
2. Тыкаем новый (сверху правее)
3. На вкладке общее заполняем
    - Имя -- то, как будет отображатся хост
    - Комментарий, если надо
    - FQDN/IP -- либо адрес, либо fqdn хоста (если нет нормального DNS -- лучше по адресу)
    - Галочки включить хост и перезагрузить хост ставим
    - Аутентификация -- выбираем пароль, пишем пасс от рута
4. На вкладке Hosted engine ставим ДА. Чтоб если отьебнет один из хостов -- энжин остался жив
5. Нажимаем ок. Скажет, что мы не настроили управление питанием -- ничего страшного.
6. Ждем конца установки, добавляем следующий хост. В паралель лучше не устанавливать
    - Хост добавляется довольно долго, это нормально

# Добавляем хранилища

Предполагается, что ты настроил nfs по инструкции выше, со всеми правами итд

1. Логинимся в енжин через вебчик
2. Идем в хранилище -> Домены
3. Нажимаем "Новый домен"
4. Центр даных -- выбираем наш, обычно Default (V5)
5. Функция домена -- выбираем, что нам надо
    - Данные -- диски виртуальных машин
    - ISO -- хранение ISO (Deprecated)
    - Экспорт -- внутреняя шара, чтоб гонять машины между серваками (костыль, нам не надо)
    - Блочное устройство -- нам не надо
6. Тип хранилища -- Выбираем нужный нам тип (NFS)
7. Используемый хост -- Хост, к которому маунтится шара. Выбираем любой. (доподлино неизвестно что это)
8. Имя, описание, комментарий -- заполняем только имя, остальное не важно
9. Путь экспорта -- путь до NFS шары в формате `host:/path`
10. Если надо настроить квоты -- идем в дополнительные параметры. Там можно настроить предупреждение, блокировки и так далее.
11. Он скажет, что домен исо устарел -- игнорируем

## Если надо удалить сторадж

1. Идем в хранилище -> домены
2. Нажимаем на хранилище, которое хотим удалить, идем в Центр данных, нажимаем на наш DC
3. Выбираем наше хранилище, выделяем его, нажимаем "обслуживание"
4. Долго ждем, пока произойдет подготовка к обслуживанию
5. Как только он перешел в режим обслуживания -- ПКМ -> отсоеденить
6. Идем в хранилище -> домены -> ПКМ -> Удалить


# Загружаем в обычный сторадж, сюда же можно и ISO

1. Идем в хранилище -> Домены -> Выбираем наш сторадж -> Диски -> Загрузить -> Начать
2. Тыкаем кнопку тест соеденения -- скажет, что не удалось подключится к службе, так как не установлен серт. Даст на него ссылку -- надо установить прям в браузер. В систему не обязательно.
3. Обновляем страничку, тыкаем еще раз тест соеденения, все должно быть норм.
4. Еще раз нажимаем начать, выбираем файл, ждем, пока он загрузится.

Загружаем так все, что нужно. Желательно под все это дело выделить отдельную шару конечно, но можно и на ту же самую, где вм.

Если мы грузим ISO -- надо ставить галочку "Может быть общим"

!!!Если хочешь грузить большие файлы -- выполни ```engine-config -s TransferImageClientInactivityTimeoutInSeconds=6000``` на ноде, где запущен энжин. Потом ```systemctl restart ovirt-engine```

# Работаем с сетями

1. Идем в Сеть -> Сети
2. Нажимаем кнопку новая
3. Заполняем имя и включаем тэгирование влан. Логика тут как в вмваре, сети друг от друга можно изолировать вланами
4. Жмем ок 
5. Проваливаемся внутрь этой сети, вкладка хосты
6. Выбираем откреплены
7. ПКМ по хосту -> настройка сетей хоста
8. Добавляем нашу сеть на все хосты таким образом
9. После этого можно аттачить к вм

В целом, сети собираются как в вмваре. Делаем кучку сетей с разными вланами. В качестве внешней сети используем ovirtmgmt дефолтную.

## Если надо удалить сеть

1. Заходим в Сеть -> Сети
2. Проваливаемся внутрь сети, которую хотим удалить
3. Справа сверху будет кнопка удалить. Жмем -- сеть перестанет существовать

Чтоб сеть уж точно потерялась навсегда -- хорошо бы ее открепить от всех хостов. Но это совершенно не обязательно.

## Бондинг

Есть два способа:

- Через портал администрирования
- Через LLDP Labler

### Портал администрирования (hosted-engine)

На коммутере, с которым будем бондить желательно включить lldp

1. Идем в ресурсы -> Хосты
2. Выбираем хост, на котором будем делать бонд, проваливаемся в него
3. Перетаскиваем одну сетевку на другую, получится бонд
4. Вводим имя и выбираем режим бондинга
    - active-backup -- данные идут по одной сетевке
    - Load balance -- Мак адрес источника XOR мак адрес назначения. Если надо, чтоб один источник ходил через конкретную карту -- наш выбор
    - Broadcast -- Все пакеты идут на все карты
    - Dynamic Link Aggregation -- LACP, режим по умолчанию. Если хочешь намутить LACP -- выбирай его
    - Аттачим сети для вм к нашему бонду и готово

# Работаем с ВМ

Предполагается, что мы уже загрузили базовый образ ВМ, либо диск, с которого будем ставится

А еще предпологается, что мы создали сети

1. Идем в Ресурсы -> Виртуальные машины
2. Жмем кнопку создать
3. Заполняем имя и выбираем тип операционной системы, больше ничего трогать не надо
4. Виртуальные диски -- загрузочные диски и дополнительные диски для ВМ. **Это именно хранение, сидиром добавляется в другом месте**
5. Нажимаем создать
6. Указываем размер, сколько нам надо. **диски тонкие по дефолту**
7. Указываем интерфейс
8. Галочка загрузочный должна стоять, если нет -- ставим.
9. Если нужен толстый диск -- в политике выделения ставим предваительно размеченный
10. Интерфейс -- по дефолту virtio-scsi, подходит для большинства линуксов. Если надо другой -- меняем
11. Нажимаем ОК
     - Если надо поправить ресурсы -- делается во вкладке Система
12. Добавляем сетевые интерфейсы ниже
13. Идем в параметры загрузки
14. Вторичное устройство выбираем CD-ROM, если хотим грузится с диска
15. Ставим галочку подключить CD и выбираем образ, с которого будем ставится
16. Нажимаем ОК
17. Машины не включаются по дефолту, включать их надо руками. ПКМ по машине -> Запустить
18. Когда машина включится -- станет доступна кнопка консоль. Консоль тут спайс, по этому хорошо бы поставить virt-viewer.

Кстати, виртуалка может висеть в статусе включается очень долго, если нет гостевого агента. Игнорируем это, консоль будет доступна.

Если надо гасануть вм

## Клонируем ВМ

Тут ваще несколько вариантов

### Создать шаблон из вм

1. Выключаем ВМ
2. Выделяем ее и тыкаем три точки в правом верхнем углу
3. Тыкаем создать шаблон
4. Пишем имя шаблона, меняем параметры, если надо
5. Ожидаем, пока виртуалка превратится в шаблон
6. Заходим в ресурсы -> шаблоны
7. Тыкаем правой кнопкой по нашему шаблону, который мы сделали -> новая вм
8. Визард мы уже заполняли, тут понятно, правим там сети если надо и ресурсы
9. Тыкаем ОК
10. Идем в ресурсы -> Виртуальные машины, ждем пока вмка доедет. Как доехала -- можно включать

### Копировать диски

1. Идем в хрнилище -> диски
2. Выбираем диск, на который мы поставили ось
3. Выделяем его, нажимаем копировать
4. Вводим новое имя
5. Ждем когда склонируется и можно аттачить к вм при создании
